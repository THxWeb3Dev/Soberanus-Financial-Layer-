<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SOBERANUS | Finance</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gold: { 400: '#F4D03F', 500: '#D4AF37', 600: '#B8860B' },
                        dark: { 950: '#020202', 900: '#080808', 800: '#0f0f0f', 700: '#141414' }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui'],
                        mono: ['JetBrains Mono', 'monospace'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    animation: {
                        'slide-arrow': 'slideArrow 1.5s infinite ease-in-out',
                        'gradient-x': 'gradientX 2s ease infinite',
                    },
                    keyframes: {
                        slideArrow: {
                            '0%': { transform: 'translateX(-100%)', opacity: '0' },
                            '50%': { opacity: '1' },
                            '100%': { transform: 'translateX(100%)', opacity: '0' },
                        },
                        gradientX: {
                            '0%, 100%': { 'background-position': '0% 50%' },
                            '50%': { 'background-position': '100% 50%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');

        body {
            background-color: #020202;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
            width: 100%;
        }
        
        html:not(.dark) body { background-color: #f3f4f6; color: #111827; }
        html:not(.dark) .glass-card { background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(0, 0, 0, 0.1); }
        html:not(.dark) header { background: rgba(255,255,255,0.95); border-bottom: 1px solid #e5e7eb; }
        html:not(.dark) .text-gray-400 { color: #4b5563; }
        html:not(.dark) .text-gray-500 { color: #6b7280; }
        html:not(.dark) .border-white\/5 { border-color: rgba(0,0,0,0.1); }
        html:not(.dark) .bg-white\/5 { background-color: rgba(0,0,0,0.05); }
        html:not(.dark) .bg-black\/40 { background-color: #fff; border: 1px solid #e5e7eb; }

        .bg-glow {
            position: fixed;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle at top, rgba(212, 175, 55, 0.05) 0%, rgba(0,0,0,0) 70%);
            top: 0; left: 0; z-index: -1; pointer-events: none;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03); 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            width: 100%;
        }

        .text-gold-gradient {
            background: linear-gradient(135deg, #F4D03F 20%, #B8860B 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }

        .btn-primary { background: #D4AF37; color: #000; font-weight: 700; transition: all 0.3s; }
        .btn-primary:hover { background: #F4D03F; }

        .manifesto-quote {
            border-left: 2px solid #D4AF37;
            padding-left: 1rem;
            font-style: italic;
            color: #a3a3a3;
        }
        html:not(.dark) .manifesto-quote { color: #4b5563; }

        input, select { font-size: 16px !important; color-scheme: dark; }
        html:not(.dark) input, html:not(.dark) select { color-scheme: light; }
        
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        /* 3D Progress Bar Style */
        .progress-3d {
            background: linear-gradient(90deg, #B8860B, #F4D03F, #B8860B);
            background-size: 200% 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.4);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-gold-500 selection:text-black">

    <div class="bg-glow"></div>

    <header class="w-full fixed top-0 z-50 bg-dark-950/80 backdrop-blur-xl border-b border-white/5 transition-colors duration-300 h-16 md:h-20">
        <div class="container mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="window.location.reload()">
                <i class="fas fa-cube text-gold-500 text-lg md:text-xl"></i>
                <span class="text-base md:text-lg font-bold tracking-[0.1em] text-gold-gradient leading-none font-serif uppercase">SOBERANUS</span>
            </div>

            <div class="flex items-center gap-2 md:gap-4">
                <button onclick="toggleTheme()" class="p-2 text-gray-400 hover:text-gold-500 transition">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <div id="auth-section">
                    <button onclick="showLogin()" class="text-gold-500 text-[10px] md:text-xs font-bold uppercase border border-gold-500/20 px-3 py-1.5 rounded">Acessar</button>
                </div>
                <div id="user-section" class="hidden flex items-center gap-2 md:gap-4">
                    <span id="header-username" class="text-[10px] md:text-sm font-bold text-gray-900 dark:text-white truncate max-w-[80px]"></span>
                    <button onclick="logout()" class="text-gray-600 hover:text-red-500"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
        </div>
    </header>

    <div class="h-16 md:h-20"></div>

    <main id="landing-page" class="flex-grow flex flex-col container mx-auto px-4 pb-10 w-full overflow-hidden">
        <section class="py-16 md:py-24 flex flex-col items-center text-center max-w-4xl mx-auto w-full">
            <h1 class="text-4xl md:text-7xl font-bold mb-6 font-serif text-gold-gradient leading-tight">SOBERANUS</h1>
            <div class="space-y-6 text-gray-500 dark:text-gray-400 font-light text-sm md:text-lg leading-relaxed max-w-2xl px-2">
                <p>O SOBERANUS é um sistema de gestão financeira descentralizada criado para quem exige ordem, clareza e autonomia no universo cripto.</p>
                <p>Aqui, você registra, analisa e organiza suas operações com precisão cirúrgica — <span class="text-gray-900 dark:text-gray-200">sem intermediários, sem vigilância e sem ruído.</span></p>
                <div class="pt-4">
                    <p class="text-gray-900 dark:text-white font-medium italic">Transforme dados em controle.</p>
                    <p class="text-gold-500 font-medium italic">Transforme controle em soberania.</p>
                </div>
            </div>
            <div class="mt-12 w-full md:w-auto">
                <button onclick="showRegister()" class="btn-primary w-full md:w-auto px-10 py-4 rounded text-xs md:text-sm tracking-widest uppercase relative overflow-hidden group">
                    <span class="relative z-10 block mb-1">COMECE A GERENCIAR AGORA</span>
                    <div class="absolute bottom-1 left-0 w-full flex justify-center opacity-70">
                        <i class="fas fa-arrow-right text-[10px] animate-slide-arrow"></i>
                    </div>
                </button>
            </div>
        </section>

        <section id="features" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 py-10">
            <div class="glass-card p-6 md:p-8 flex flex-col justify-between group"><div><i class="fas fa-fingerprint text-3xl text-gold-500/80 mb-6 group-hover:text-gold-400 transition"></i><h3 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-4 font-serif">Soberania Digital</h3><p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-4">O poder volta para o titular. Você controla seus registros, suas métricas e suas decisões.</p></div><div class="mt-6 pt-4 border-t border-gray-200 dark:border-white/5"><p class="manifesto-quote text-xs">Controle absoluto.<br>Vigilância zero.</p></div></div>
            <div class="glass-card p-6 md:p-8 flex flex-col justify-between group"><div><i class="fas fa-chart-line text-3xl text-gold-500/80 mb-6 group-hover:text-gold-400 transition"></i><h3 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-4 font-serif">Gestão Inteligente</h3><p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-4">Dados claros. Decisões conscientes. Registre compras e saques via PIX e DePIX com precisão.</p></div><div class="mt-6 pt-4 border-t border-gray-200 dark:border-white/5"><p class="manifesto-quote text-xs">Aqui, números não confundem.<br>Eles obedecem.</p></div></div>
            <div class="glass-card p-6 md:p-8 flex flex-col justify-between group"><div><i class="fas fa-user-shield text-3xl text-gold-500/80 mb-6 group-hover:text-gold-400 transition"></i><h3 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-4 font-serif">Privacidade & Segurança</h3><p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-4">O que é seu permanece com você. Nenhum rastreamento. Nenhum monitoramento de IP.</p></div><div class="mt-6 pt-4 border-t border-gray-200 dark:border-white/5"><p class="manifesto-quote text-xs">Privacidade não é um recurso.<br>É o fundamento.</p></div></div>
            <div class="glass-card p-6 md:p-8 flex flex-col justify-between group"><div><i class="fas fa-dove text-3xl text-gold-500/80 mb-6 group-hover:text-gold-400 transition"></i><h3 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-4 font-serif">Liberdade Financeira</h3><p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-4">Sem travas. Sem intermediários. Acompanhe seus dados em tempo real.</p></div><div class="mt-6 pt-4 border-t border-gray-200 dark:border-white/5"><p class="manifesto-quote text-xs">Conhecimento é o que separa o operador do refém.</p></div></div>
            <div class="glass-card p-6 md:p-8 flex flex-col justify-between md:col-span-2 group relative overflow-hidden"><div class="absolute right-0 top-0 p-8 opacity-5"><i class="fas fa-water text-9xl text-black dark:text-white"></i></div><div class="relative z-10"><i class="fas fa-layer-group text-3xl text-gold-500/80 mb-6 group-hover:text-gold-400 transition"></i><h3 class="text-lg md:text-xl font-bold text-gray-900 dark:text-white mb-4 font-serif">Infraestrutura Liquid Network</h3><p class="text-sm text-gray-500 dark:text-gray-400 leading-relaxed mb-6 max-w-lg">Eficiência ancorada no Bitcoin. Uma camada financeira construída sobre o Bitcoin para emissão e troca de ativos com confidencialidade.</p></div><div class="mt-6 pt-4 border-t border-gray-200 dark:border-white/5 relative z-10"><p class="manifesto-quote text-xs">Tecnologia antiga no espírito.<br>Afiada na execução.</p></div></div>
        </section>

        <section class="py-16 md:py-20 border-t border-gray-200 dark:border-white/5 text-center px-4">
            <h2 class="text-xs md:text-sm font-bold text-gold-500 uppercase tracking-[0.3em] mb-8">Manifesto Soberanus</h2>
            <div class="space-y-6 text-base md:text-xl font-serif text-gray-600 dark:text-gray-300 leading-relaxed max-w-3xl mx-auto">
                <p>O sistema sempre foi grande. Complexo. Opaco. Intimidante.</p>
                <p>O SOBERANUS nasce para restaurar a ordem. Não para confrontar o sistema com caos, mas para vencê-lo com clareza, precisão e disciplina.</p>
                <p class="text-gray-900 dark:text-white">Aqui, o usuário não foge. Ele entende. Registra. Declara. Domina.</p>
            </div>
            <div class="flex flex-wrap justify-center gap-4 md:gap-8 mt-10 text-[10px] md:text-xs font-mono text-gray-500 uppercase tracking-widest">
                <span>Sem vigilância</span><span class="hidden md:inline">•</span><span>Sem intermediários</span><span class="hidden md:inline">•</span><span>Sem dependência</span>
            </div>
            <div class="mt-12 p-6 border-l-2 border-gold-500 bg-white/5 text-left inline-block">
                <p class="text-sm italic text-gray-500 dark:text-gray-400">"Soberania não é rebeldia. É responsabilidade.<br><span class="text-gray-900 dark:text-white not-italic mt-2 block">E quem assume responsabilidade não teme o Leviatã."</span></p>
            </div>
        </section>

        <section class="mt-8">
            <div class="glass-card px-4 md:px-6 py-6 flex flex-col md:flex-row justify-between items-center gap-6 border-t border-gray-200 dark:border-white/5 text-center md:text-left">
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-gold-500"><i class="fas fa-hand-holding-heart"></i></div>
                    <div><p class="text-sm font-bold text-gray-900 dark:text-white uppercase tracking-wide">Suporte Voluntário</p><p class="text-xs text-gray-500 mt-1">Contribuição Soberana. Apoio consciente. Sem obrigação.</p></div>
                </div>
                <button onclick="openDonationModal()" class="btn-primary px-6 py-3 rounded text-xs font-bold uppercase tracking-wider w-full md:w-auto">FAÇA SUA DOAÇÃO</button>
            </div>
        </section>
    </main>

    <main id="dashboard" class="hidden flex-grow container mx-auto px-4 py-6 overflow-x-hidden">
        <div class="flex flex-col gap-6 items-start mb-8 border-b border-gray-200 dark:border-white/5 pb-6">
            <div class="w-full">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white font-serif truncate">Olá, <span id="dash-username" class="text-gold-500">Usuário</span></h2>
                <p class="text-xs md:text-sm text-gray-500 dark:text-gray-400 italic mt-1">Com a SOBERANUS, você tem Clareza para declarar e Liberdade para decidir!</p>
            </div>
            <div class="w-full">
                <span class="text-[10px] text-gold-500 font-mono block mb-1 uppercase tracking-widest">Saldo Total Estimado</span>
                <div class="flex items-center gap-3">
                    <span id="total-balance-display" class="text-2xl md:text-4xl font-bold text-gray-900 dark:text-white tracking-tight">R$ •••••</span>
                    <button onclick="toggleBalance()" class="text-gray-400 text-xl"><i class="fas fa-eye" id="balance-icon"></i></button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3 md:gap-4 mb-8">
            <button onclick="openModal('modal-buy')" class="glass-card p-4 h-28 md:h-40 flex flex-col justify-between items-start text-left hover:border-green-500/30">
                <i class="fas fa-arrow-down text-green-600 dark:text-green-500 text-xl"></i>
                <span class="font-bold text-xs md:text-lg text-gray-900 dark:text-white mt-auto">Comprar</span>
            </button>
            <button onclick="openModal('modal-sell')" class="glass-card p-4 h-28 md:h-40 flex flex-col justify-between items-start text-left hover:border-red-500/30">
                <i class="fas fa-arrow-up text-red-600 dark:text-red-500 text-xl"></i>
                <span class="font-bold text-xs md:text-lg text-gray-900 dark:text-white mt-auto">Sacar</span>
            </button>
            <button onclick="openModal('modal-wallet')" class="glass-card p-4 h-28 md:h-40 flex flex-col justify-between items-start text-left hover:border-blue-500/30">
                <i class="fas fa-wallet text-blue-600 dark:text-blue-500 text-xl"></i>
                <span class="font-bold text-xs md:text-lg text-gray-900 dark:text-white mt-auto">Carteira</span>
            </button>
            <button onclick="openModal('modal-ir')" class="glass-card p-4 h-28 md:h-40 flex flex-col justify-between items-start text-left border-gold-500/20">
                <i class="fas fa-file-contract text-gold-600 dark:text-gold-500 text-xl"></i>
                <span class="font-bold text-xs md:text-lg text-gold-600 dark:text-gold-500 mt-auto">Declaração</span>
            </button>
        </div>

        <div class="mb-8">
            <div class="glass-card p-4 md:p-6 flex flex-col md:flex-row justify-between items-center gap-4 w-full">
                <div class="w-full md:w-1/3">
                    <h3 class="text-[9px] text-gray-400 uppercase tracking-widest mb-1">Resultado Financeiro (PnL)</h3>
                    <span id="pnl-value" class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white tracking-tight">R$ 0,00</span>
                </div>
                <div class="w-full md:w-2/3">
                    <div class="grid grid-cols-2 gap-4 text-[9px] mb-2">
                        <div class="flex justify-between"><span class="text-gray-500">Entradas</span><span id="total-in" class="text-gray-900 dark:text-white font-mono">R$ 0</span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Saídas</span><span id="total-out" class="text-gray-900 dark:text-white font-mono">R$ 0</span></div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-[#111] h-1.5 rounded-full overflow-hidden">
                        <div id="pnl-bar" class="bg-gray-500 h-full w-0 transition-all duration-500"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card p-4 mb-8 overflow-hidden">
            <h3 class="text-xs font-bold mb-4 uppercase tracking-widest text-gold-500">Livro Razão</h3>
            <div class="overflow-x-auto w-full">
                <table class="w-full text-left text-[10px] md:text-xs">
                    <thead>
                        <tr class="border-b border-gray-200 dark:border-white/5 text-gray-500">
                            <th class="py-2 pr-2 font-semibold">Data</th>
                            <th class="py-2 pr-2 font-semibold">Tipo</th>
                            <th class="py-2 pr-2 font-semibold text-right">Valor</th>
                            <th class="py-2 font-semibold text-right">Qtd</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table-body" class="divide-y divide-gray-200 dark:divide-white/5"></tbody>
                </table>
            </div>
        </div>

        <div class="glass-card p-4 h-64 md:h-80"><canvas id="evolutionChart"></canvas></div>
        <div class="text-center mt-12 pb-10"><button onclick="openDonationModal()" class="text-[10px] text-gray-500 border-b border-dashed border-gray-700 uppercase tracking-widest">Contribuição Soberana</button></div>
    </main>

    <div id="auth-forms" class="hidden fixed inset-0 z-[60] bg-black/95 backdrop-blur-md flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-sm md:max-w-md p-6 md:p-8 relative bg-white dark:bg-dark-900">
            <button onclick="closeAuth()" class="absolute top-4 right-4 text-gray-500 hover:text-black dark:hover:text-white"><i class="fas fa-times"></i></button>
            <div id="login-form" class="hidden text-center">
                <i class="fas fa-fingerprint text-4xl text-gold-500 mb-6"></i>
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2 font-serif">Acesso Soberano</h2>
                <input type="text" id="login-username" placeholder="Usuário" class="w-full bg-gray-100 dark:bg-dark-800 border border-gray-300 dark:border-gray-700 rounded p-3 text-gray-900 dark:text-white mb-3 focus:border-gold-500 outline-none text-base">
                <input type="password" id="login-password" placeholder="Senha" class="w-full bg-gray-100 dark:bg-dark-800 border border-gray-300 dark:border-gray-700 rounded p-3 text-gray-900 dark:text-white mb-6 focus:border-gold-500 outline-none text-base">
                <button onclick="performLogin()" class="w-full btn-primary py-3 rounded text-sm uppercase">ENTRAR</button>
                <button onclick="switchAuthMode('register')" class="mt-6 text-xs text-gold-500 hover:text-black dark:hover:text-white transition uppercase tracking-wide">Criar nova identidade</button>
            </div>
            <div id="register-form" class="hidden text-center">
                <i class="fas fa-key text-4xl text-gold-500 mb-6"></i>
                <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2 font-serif">Gerar Chaves</h2>
                <input type="text" id="reg-username" placeholder="Novo Usuário" class="w-full bg-gray-100 dark:bg-dark-800 border border-gray-300 dark:border-gray-700 rounded p-3 text-gray-900 dark:text-white mb-3 focus:border-gold-500 outline-none text-base">
                <input type="password" id="reg-password" placeholder="Nova Senha" class="w-full bg-gray-100 dark:bg-dark-800 border border-gray-300 dark:border-gray-700 rounded p-3 text-gray-900 dark:text-white mb-6 focus:border-gold-500 outline-none text-base">
                <button onclick="performRegister()" class="w-full btn-primary py-3 rounded text-sm uppercase">CRIAR CARTEIRA</button>
                <button onclick="switchAuthMode('login')" class="mt-6 text-xs text-gold-500 hover:text-black dark:hover:text-white transition uppercase tracking-wide">Voltar para Login</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 z-[70] bg-black/95 backdrop-blur-md flex items-center justify-center p-4">
        <div id="modal-content" class="glass-card w-full max-w-lg p-6 md:p-8 relative max-h-[90vh] overflow-y-auto bg-white dark:bg-dark-900">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-black dark:hover:text-white"><i class="fas fa-times"></i></button>
            <div id="modal-body"></div>
        </div>
    </div>

    <footer class="mt-auto py-8 text-center border-t border-gray-200 dark:border-white/5 bg-gray-100 dark:bg-[#020202]">
        <p class="text-gray-500 text-[10px] font-mono uppercase tracking-widest">THxWeb3Dev | SOBERANUS &copy; 2026</p>
    </footer>

    <script>
        // Inicialização do Web App Telegram
        window.Telegram.WebApp.ready();

        let balanceVisible = false;
        let currentUser = null; 
        let transactions = []; 
        let charts = {}; 

        function init() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                if(document.getElementById('theme-icon')) document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
            }
            const storedUser = sessionStorage.getItem('soberanus_user');
            if (storedUser) loginUser(JSON.parse(storedUser));
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        function toggleBalance() {
            balanceVisible = !balanceVisible;
            document.getElementById('balance-icon').className = balanceVisible ? 'fas fa-eye-slash' : 'fas fa-eye';
            calculateMetrics();
        }

        function showLogin() { document.getElementById('auth-forms').classList.remove('hidden'); switchAuthMode('login'); }
        function showRegister() { document.getElementById('auth-forms').classList.remove('hidden'); switchAuthMode('register'); }
        function closeAuth() { document.getElementById('auth-forms').classList.add('hidden'); }
        function switchAuthMode(mode) {
            document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', mode !== 'register');
        }
        function performRegister() {
            const user = document.getElementById('reg-username').value;
            if(!user) return alert('Identificação necessária.');
            localStorage.setItem('sob_user_' + user, JSON.stringify({ username: user, createdAt: new Date() }));
            loginUser({ username: user }); closeAuth();
        }
        function performLogin() {
            const user = document.getElementById('login-username').value;
            let userData = JSON.parse(localStorage.getItem('sob_user_' + user));
            if (!userData) userData = { username: user }; 
            loginUser(userData); closeAuth();
        }
        function loginUser(user) {
            currentUser = user; sessionStorage.setItem('soberanus_user', JSON.stringify(user));
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('user-section').classList.remove('hidden');
            document.getElementById('header-username').textContent = user.username;
            document.getElementById('dash-username').textContent = user.username;
            loadTransactions(); updateDashboard();
        }
        function logout() { sessionStorage.removeItem('soberanus_user'); window.location.reload(); }

        function loadTransactions() { const data = localStorage.getItem('sob_tx_' + currentUser.username); transactions = data ? JSON.parse(data) : []; }
        function saveTransactions() { localStorage.setItem('sob_tx_' + currentUser.username, JSON.stringify(transactions)); updateDashboard(); }
        function updateDashboard() { updateHistoryTable(); calculateMetrics(); renderCharts(); }

        function calculateMetrics() {
            let totalIn = 0, totalOut = 0, currentHoldings = 0, totalFees = 0; 
            transactions.forEach(t => { 
                const extraFee = parseFloat(t.feeFixed || 0);
                totalFees += extraFee;
                if(t.type === 'BUY') { totalIn += t.fiatValue; currentHoldings += t.cryptoValue; } 
                else { totalOut += t.fiatValue; currentHoldings -= t.cryptoValue; } 
            });
            const estimatedFiatBalance = currentHoldings * 1.00; 
            const pnl = (totalOut - totalIn) - totalFees + estimatedFiatBalance;
            
            document.getElementById('total-balance-display').innerText = balanceVisible ? `R$ ${estimatedFiatBalance.toFixed(2)}` : `R$ •••••`;
            const pnlEl = document.getElementById('pnl-value');
            pnlEl.innerText = `R$ ${pnl.toFixed(2)}`;
            pnlEl.className = `text-xl md:text-2xl font-bold tracking-tight ${pnl >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`;
            document.getElementById('total-in').innerText = `R$ ${totalIn.toFixed(0)}`;
            document.getElementById('total-out').innerText = `R$ ${totalOut.toFixed(0)}`;
            document.getElementById('pnl-bar').style.width = '100%';
            document.getElementById('pnl-bar').className = `h-full ${pnl >= 0 ? 'bg-green-500' : 'bg-red-500'}`;
        }

        function registerTransaction(type) {
            const valFiat = parseFloat(document.getElementById('inp-fiat').value)||0;
            const valCrypto = parseFloat(document.getElementById('inp-crypto').value)||0;
            const feePct = parseFloat(document.getElementById('inp-fee-pct').value)||0;
            const feeFixed = parseFloat(document.getElementById('inp-fee-fixed').value)||0;
            const dateInput = document.getElementById('inp-date').value;
            if(valFiat <= 0 || !dateInput) return alert("Dados inválidos.");
            const parts = dateInput.split('-');
            const tx = { id: Date.now(), date: new Date(parts[0], parts[1]-1, parts[2], 12,0,0).toISOString(), type, fiatValue: valFiat, cryptoValue: valCrypto, feePct, feeFixed, feeFiatTotal: feeFixed };
            transactions.push(tx); saveTransactions(); closeModal();
        }

        function openModal(type) {
            const overlay = document.getElementById('modal-overlay'); const body = document.getElementById('modal-body'); overlay.classList.remove('hidden');
            const today = new Date().toISOString().split('T')[0];
            const inputClass = "w-full bg-gray-100 dark:bg-dark-800 border border-gray-300 dark:border-gray-700 rounded p-3 text-gray-900 dark:text-white focus:border-gold-500 outline-none placeholder-gray-500 text-sm";
            const labelClass = "block text-[10px] text-gray-500 mb-1 uppercase tracking-wider font-bold";
            let html = '';

            if(type === 'modal-buy' || type === 'modal-sell') {
                const isBuy = type === 'modal-buy';
                const color = isBuy ? 'text-green-600 dark:text-green-500' : 'text-red-600 dark:text-red-500';
                html = `<h2 class="text-xl font-bold ${color} mb-6 border-b border-gray-200 dark:border-gray-800 pb-4 font-serif">${isBuy?'Registrar Compra':'Registrar Saque'}</h2><div class="space-y-4"><div><label class="${labelClass}">Data</label><input type="date" id="inp-date" value="${today}" class="${inputClass}"></div><div class="grid grid-cols-2 gap-4"><div><label class="${labelClass}">Valor R$</label><input type="number" id="inp-fiat" class="${inputClass}"></div><div><label class="${labelClass}">Qtd DePIX</label><input type="number" id="inp-crypto" class="${inputClass}"></div></div><div class="grid grid-cols-2 gap-4 bg-gray-5 dark:bg-white/5 p-3 rounded"><div><label class="${labelClass}">Taxa %</label><input type="number" id="inp-fee-pct" placeholder="0" class="${inputClass}"></div><div><label class="${labelClass}">Taxa Fixa R$</label><input type="number" id="inp-fee-fixed" placeholder="0" class="${inputClass}"></div></div><button onclick="registerTransaction('${isBuy?'BUY':'SELL'}')" class="w-full py-4 mt-2 font-bold rounded bg-gray-900 dark:bg-white text-white dark:text-black uppercase tracking-widest text-xs">Salvar Registro</button></div>`;
            } else if (type === 'modal-wallet') {
                let currentHoldings = 0; transactions.forEach(t => { if(t.type === 'BUY') currentHoldings += t.cryptoValue; else currentHoldings -= t.cryptoValue; });
                const valDePIX = currentHoldings;
                const valBRL = valDePIX * 1; 
                const valUSD = valBRL / 5.20; 
                const valEUR = valBRL / 5.60;
                const valSats = (valBRL / 600000) * 100000000; 
                html = `<h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6 font-serif border-b border-gray-200 dark:border-white/5 pb-4">Saldos Globais</h2><div class="space-y-3">
                    <div class="flex justify-between p-3 bg-gray-50 dark:bg-white/5 rounded"><span class="text-gray-500 text-xs font-bold">DEPIX</span><span class="text-gray-900 dark:text-white font-mono">${valDePIX.toFixed(4)}</span></div>
                    <div class="flex justify-between p-3 bg-gray-50 dark:bg-white/5 rounded"><span class="text-orange-500 text-xs font-bold">SATOCHIS BTC</span><span class="text-gray-900 dark:text-white font-mono">${valSats.toFixed(0)}</span></div>
                    <div class="flex justify-between p-3 bg-gray-50 dark:bg-white/5 rounded"><span class="text-green-600 dark:text-green-400 text-xs font-bold">REAL (BRL)</span><span class="text-gray-900 dark:text-white font-mono">R$ ${valBRL.toFixed(2)}</span></div>
                    <div class="flex justify-between p-3 bg-gray-50 dark:bg-white/5 rounded"><span class="text-blue-500 text-xs font-bold">DOLLAR (USD)</span><span class="text-gray-900 dark:text-white font-mono">$ ${valUSD.toFixed(2)}</span></div>
                    <div class="flex justify-between p-3 bg-gray-50 dark:bg-white/5 rounded"><span class="text-indigo-500 text-xs font-bold">EURO (EUR)</span><span class="text-gray-900 dark:text-white font-mono">€ ${valEUR.toFixed(2)}</span></div></div>`;
            } else if (type === 'modal-ir') {
                html = `<h2 class="text-xl font-bold text-gold-500 mb-6 font-serif">Gerar Relatório Fiscal</h2><div class="space-y-4"><input type="text" id="ir-name" placeholder="Nome Completo" class="${inputClass}"><input type="text" id="ir-cpf" placeholder="CPF" class="${inputClass}"><input type="text" id="ir-address" placeholder="Endereço Completo" class="${inputClass}"><input type="text" id="ir-cep" placeholder="CEP" class="${inputClass}"><button onclick="generatePDF()" class="w-full py-3 btn-primary rounded mt-2 text-xs uppercase tracking-widest">Baixar PDF</button></div>`;
            } else if (type === 'modal-pix') {
                html = `
                    <h2 class="text-xl font-bold text-green-600 dark:text-green-500 mb-2 font-serif">Doação via PIX</h2>
                    <p class="text-[10px] text-gray-400 mb-2">Regras: Mínimo R$ 5,00 | Máximo R$ 3.000,00</p>
                    <p class="text-[10px] text-gray-400 mb-6">Use ponto (.) para centavos (ex: 10.50)</p>
                    <div id="pix-input-area">
                        <input type="number" id="pix-amount" value="10" min="5" class="${inputClass} text-center text-3xl font-bold mb-6 !py-4">
                        <button onclick="fetchPixCode()" class="w-full py-4 bg-green-600 hover:bg-green-500 rounded font-bold text-black uppercase tracking-widest text-xs">Gerar QR Code</button>
                    </div>
                    <div id="pix-loading" class="hidden flex-col items-center">
                        <div class="w-full bg-gray-700 rounded-full h-4 relative overflow-hidden shadow-inner mb-2 progress-3d">
                            <div class="h-full w-full absolute top-0 left-0 animate-gradient-x"></div>
                        </div>
                        <p class="text-gold-500 text-xs font-bold animate-pulse">Preparando sua Doação...</p>
                    </div>
                    <div id="pix-result" class="hidden flex flex-col items-center mt-4">
                        <div class="bg-white p-3 rounded mb-4" id="pix-qr-container"></div>
                        <div class="flex w-full">
                            <input type="text" id="pix-string" readonly class="w-full bg-gray-100 dark:bg-dark-900 border border-gray-300 dark:border-gray-700 rounded-l p-3 text-xs font-mono text-gray-500">
                            <button onclick="copyPixString()" class="bg-gray-700 px-4 rounded-r hover:bg-gray-600 text-white"><i class="fas fa-copy"></i></button>
                        </div>
                    </div>
                `;
            }
            body.innerHTML = html;
        }

        function openDonationModal() {
            const overlay = document.getElementById('modal-overlay'); const body = document.getElementById('modal-body'); overlay.classList.remove('hidden');
            body.innerHTML = `<div class="text-center mb-8"><i class="fas fa-hand-holding-heart text-3xl text-gold-500 mb-4"></i><h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2 font-serif uppercase tracking-widest">Contribuição Soberana</h2><p class="text-xs text-gray-500">Apoio consciente. Sem obrigação.</p></div><div class="mb-6 p-4 border-l-2 border-gold-500 bg-gray-50 dark:bg-white/5 text-left"><p class="text-sm text-gray-600 dark:text-gray-300 italic leading-relaxed">"O SOBERANUS é mantido de forma independente... Se este sistema gera valor para você, contribuições voluntárias ajudam a sustentar sua continuidade."</p></div><button onclick="openModal('modal-pix')" class="w-full py-4 mb-8 bg-green-100 dark:bg-green-900/20 border border-green-500/30 text-green-700 dark:text-green-400 hover:bg-green-500 hover:text-white dark:hover:text-black rounded font-bold uppercase tracking-widest text-xs transition">Doar via PIX</button><div class="space-y-3 mb-8"><div class="flex items-center justify-between bg-gray-100 dark:bg-black/40 p-3 rounded border border-gray-300 dark:border-white/5 group hover:border-gold-500/30 transition"><div><span class="text-[10px] text-gold-600 dark:text-gold-500 font-bold block uppercase">Bitcoin On-Chain</span><code class="text-[10px] text-gray-500 font-mono">bc1qvsu6...aepd</code></div><button onclick="copyAddress('bc1qvsu6n806jg8zswkvpyqxe9dujs6q5398jkaepd', 'Bitcoin On-Chain')" class="text-gray-400 hover:text-black dark:hover:text-white px-2"><i class="fas fa-copy"></i></button></div><div class="flex items-center justify-between bg-gray-100 dark:bg-black/40 p-3 rounded border border-gray-300 dark:border-white/5 group hover:border-gold-500/30 transition"><div><span class="text-[10px] text-gold-600 dark:text-gold-500 font-bold block uppercase">Bitcoin Lightning</span><code class="text-[10px] text-gray-500 font-mono">web3sats...com</code></div><button onclick="copyAddress('web3satsfinance@ln.satsails.com', 'Bitcoin Lightning')" class="text-gray-400 hover:text-black dark:hover:text-white px-2"><i class="fas fa-copy"></i></button></div><div class="flex items-center justify-between bg-gray-100 dark:bg-black/40 p-3 rounded border border-gray-300 dark:border-white/5 group hover:border-gold-500/30 transition"><div><span class="text-[10px] text-gold-600 dark:text-gold-500 font-bold block uppercase">Liquid Network</span><code class="text-[10px] text-gray-500 font-mono">lq1qq2gf...0nt</code></div><button onclick="copyAddress('lq1qq2gflwdl95jlexg6tmulcdgdlrv8jwc64ulnpp0jhs0xgx0v02vhyqqj6ag980al9gumlx3dk78q2q6yntqgzz9suuzjgf0nt', 'Liquid Network')" class="text-gray-400 hover:text-black dark:hover:text-white px-2"><i class="fas fa-copy"></i></button></div><div class="flex items-center justify-between bg-gray-100 dark:bg-black/40 p-3 rounded border border-gray-300 dark:border-white/5 group hover:border-gold-500/30 transition"><div><span class="text-[10px] text-gold-600 dark:text-gold-500 font-bold block uppercase">EVM (BSC/POL)</span><code class="text-[10px] text-gray-500 font-mono">0x135a83...8ed</code></div><button onclick="copyAddress('0x135a83c5a641a4265297853dd70b6f7565e5c8ed', 'EVM (BSC/Base/Polygon)')" class="text-gray-400 hover:text-black dark:hover:text-white px-2"><i class="fas fa-copy"></i></button></div></div><p class="text-[10px] text-gray-400 text-center uppercase tracking-wide">Nenhuma funcionalidade é bloqueada. Nenhum privilégio é comprado.<br>Apoiar é um ato de convicção.</p>`;
        }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); }

        function renderCharts() {
            const ctxEv = document.getElementById('evolutionChart').getContext('2d');
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            let buys = new Array(12).fill(0), sells = new Array(12).fill(0);
            transactions.forEach(t => { const m = new Date(t.date).getMonth(); if(t.type === 'BUY') buys[m] += t.fiatValue; else sells[m] += t.fiatValue; });
            if(charts.evolution) charts.evolution.destroy();
            charts.evolution = new Chart(ctxEv, { type: 'bar', data: { labels: months, datasets: [{ label: 'Entradas', data: buys, backgroundColor: '#22c55e', borderRadius: 2 }, { label: 'Saídas', data: sells, backgroundColor: '#ef4444', borderRadius: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#6b7280', font: {size: 9, family: 'Mono'} } }, y: { grid: { color: 'rgba(107, 114, 128, 0.2)' }, ticks: { color: '#6b7280', font: {size: 9, family: 'Mono'} } } } } });
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('transaction-table-body');
            tbody.innerHTML = transactions.length ? transactions.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => `
                <tr class="border-b border-gray-200 dark:border-white/5">
                    <td class="px-2 py-3 font-mono text-gray-500 whitespace-nowrap">${new Date(t.date).toLocaleDateString('pt-BR')}</td>
                    <td class="px-2 py-3 font-bold ${t.type==='BUY'?'text-green-600 dark:text-green-500':'text-red-600 dark:text-red-500'}">${t.type==='BUY'?'ENT':'SAI'}</td>
                    <td class="px-2 py-3 font-mono text-gray-900 dark:text-white text-right">R$ ${t.fiatValue.toFixed(2)}</td>
                    <td class="px-2 py-3 font-mono text-gray-400 text-right">${t.cryptoValue.toFixed(4)}</td>
                </tr>
            `).join('') : '<tr><td colspan="4" class="py-10 text-center text-gray-600">Nenhum registro</td></tr>';
        }

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFillColor(20, 20, 20); doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(212, 175, 55); doc.setFontSize(24); doc.setFont("helvetica", "bold"); doc.text("SOBERANUS", 14, 25);
            doc.setTextColor(255, 255, 255); doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("Financial Layer | Extrato Auxiliar", 140, 25);
            const name = document.getElementById('ir-name').value || "N/A";
            const cpf = document.getElementById('ir-cpf').value || "N/A";
            const address = document.getElementById('ir-address').value || "N/A";
            const cep = document.getElementById('ir-cep').value || "N/A";
            doc.setTextColor(0,0,0); doc.setFontSize(10); 
            doc.text(`Contribuinte: ${name}`, 14, 50); doc.text(`CPF: ${cpf}`, 14, 56); doc.text(`Endereço: ${address}`, 14, 62); doc.text(`CEP: ${cep}`, 14, 68);
            doc.setDrawColor(200, 200, 200); doc.line(14, 72, 196, 72);
            let totalBuy = 0, totalSell = 0, totalFees = 0, totalPnL = 0;
            let rows = transactions.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(t => {
                const extraFee = parseFloat(t.feeFixed || 0); totalFees += extraFee;
                if(t.type === 'BUY') { totalBuy += t.fiatValue; } else { totalSell += t.fiatValue; }
                return [new Date(t.date).toLocaleDateString('pt-BR'), t.type==='BUY'?'COMPRA':'VENDA', `R$ ${t.fiatValue.toFixed(2)}`, `${t.cryptoValue.toFixed(4)}`, t.feePct > 0 ? `${t.feePct}%` : `R$ ${extraFee.toFixed(2)}`];
            });
            totalPnL = (totalSell - totalBuy) - totalFees;
            doc.autoTable({ startY: 75, head: [['DATA','OPERAÇÃO','VALOR BRL','QTD DEPIX','TAXAS']], body: rows, headStyles: {fillColor:[20,20,20], textColor:[212,175,55]} });
            let finalY = doc.lastAutoTable.finalY + 15;
            doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text(`RESUMO CONSOLIDADO ANUAL ${new Date().getFullYear()}`, 14, finalY);
            doc.autoTable({ startY: finalY + 5, head: [['TOTAL COMPRADO', 'TOTAL VENDIDO', 'TAXAS EXTRA', 'TOTAL LUCRO/PREJUIZO']], body: [[`R$ ${totalBuy.toFixed(2)}`, `R$ ${totalSell.toFixed(2)}`, `R$ ${totalFees.toFixed(2)}`, `R$ ${totalPnL.toFixed(2)}`]], headStyles: {fillColor:[50,50,50], textColor:[255,255,255]}, styles: {halign: 'center'} });
            doc.save('soberanus_report.pdf');
            closeModal();
        }

        async function fetchPixCode() {
            const val = document.getElementById('pix-amount').value;
            // Efeitos visuais
            document.getElementById('pix-input-area').classList.add('hidden');
            document.getElementById('pix-loading').classList.remove('hidden');
            document.getElementById('pix-loading').classList.add('flex'); // Show flex container

            try {
                const res = await fetch(`https://liquidx.pro/api/integrated-payment?value=${val}&description=Donation&code=YITOWQXGVZETOPAY`);
                const json = await res.json();
                
                if(json.pix.success) {
                    const copyPaste = json.pix.data.response.qrCopyPaste;
                    document.getElementById('pix-loading').classList.add('hidden');
                    document.getElementById('pix-loading').classList.remove('flex');
                    document.getElementById('pix-result').classList.remove('hidden');
                    document.getElementById('pix-string').value = copyPaste;
                    const container = document.getElementById('pix-qr-container');
                    container.innerHTML = ""; 
                    new QRCode(container, { text: copyPaste, width: 180, height: 180, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.L });
                } else { throw new Error('API Error'); }
            } catch(e) { 
                alert('Erro na comunicação com gateway.'); 
                document.getElementById('pix-loading').classList.add('hidden');
                document.getElementById('pix-loading').classList.remove('flex');
                document.getElementById('pix-input-area').classList.remove('hidden');
            }
        }

        function copyPixString() { navigator.clipboard.writeText(document.getElementById('pix-string').value); alert('Código Copiado!'); }
        function copyAddress(address, networkName) {
            navigator.clipboard.writeText(address);
            Swal.fire({ icon: 'warning', title: 'Endereço Copiado!', html: `Você copiou o endereço da rede: <br><b>${networkName}</b><br><br>Envie APENAS através desta rede.`, background: '#1a1a1a', color: '#fff', confirmButtonColor: '#D4AF37' });
        }

        window.onload = init;
    </script>
</body>
</html>

